<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Fight Prior &middot; MMA Data Science and Statistical Analysis
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/extras.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><img src="https://raw.githubusercontent.com/fightprior/fightprior.github.io/master/public/fightprior_logo.png" height=45 </img>  Follow us on twitter <a href="https://twitter.com/Fight_Prior">@Fight_Prior</a></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Fight Prior</a>
            <small>MMA Data Science and Statistical Analysis</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://www.fightprior.com/2016/05/17/smallWorldMMA/">
        The not-so-small-world network of MMA fighters
      </a>
    </h1>

    <span class="post-date">17 May 2016</span>

    <p>There are over 140,000 amateur and professional mixed martial artists and the matchups between these fighters are far from random. It seems pretty obvious that <a href="http://www.sherdog.com/fighter/Holly-Holm-75125">Holly Holm’s</a> next fight won’t be against <a href="http://www.sherdog.com/fighter/Antonio-Silva-12354">Bigfoot Silva</a>, but it is less clear how many reasonable matchups are out there for most fighters.</p>

<p>One way we can think about this question is that fighters will tend to compete against other fighters who are relatively similar to them. An amateur fighter may compete against fighters in his town and in neighboring towns. His opponents may do the same. While this fighter is unlikely to compete against fighters who live two towns over, he can still be said to be relatively closely connected to these fighters because they are only two jumps aways. At a broader scale, MMA fighters who are very different may be many jumps apart, seperated by large geographical barriers or other obstructions.</p>

<p>Looking at the matchups between pairs of fighters is the key to determining what drives these matchups overall. This analysis builds on past posts:</p>

<ol>
  <li><a href="http://www.fightprior.com/2016/04/29/scrapingMMA/">Large-scale acquisition of fighter and fight data</a></li>
  <li><a href="http://www.fightprior.com/2016/05/05/summarizingFights/">Quantitatively summarizing 240,000 MMA fights</a></li>
  <li><a href="http://www.fightprior.com/2016/05/13/summarizingFighters/">Summarizing the demographics of 140,000 MMA fighters</a></li>
</ol>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1">## Fighter-level data
</span><span class="n">fighters</span> <span class="o">&lt;-</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/processed_fight_data/MMA_all_fighters.Rds"</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighters</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Display_name</span><span class="o">:</span><span class="n">Weight_class</span><span class="p">),</span> <span class="m">4</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Display_name</th>
      <th style="text-align: left">Record</th>
      <th style="text-align: left">Primary_affiliation</th>
      <th style="text-align: left">Gender</th>
      <th style="text-align: left">Nationality</th>
      <th style="text-align: left">Birthday</th>
      <th style="text-align: right">Height</th>
      <th style="text-align: right">Weight</th>
      <th style="text-align: left">Weight_class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei “The Pit Bull” Arlovski</td>
      <td style="text-align: left">25-11 (1 NC)</td>
      <td style="text-align: left">UFC (Current)</td>
      <td style="text-align: left">Male</td>
      <td style="text-align: left">Belarus</td>
      <td style="text-align: left">1979-02-04</td>
      <td style="text-align: right">193.04</td>
      <td style="text-align: right">109.32</td>
      <td style="text-align: left">Heavyweight</td>
    </tr>
    <tr>
      <td style="text-align: left">Ikuhisa “Minowaman” Minowa</td>
      <td style="text-align: left">60-40-8</td>
      <td style="text-align: left">PRIDE (Past)</td>
      <td style="text-align: left">Male</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">1976-01-12</td>
      <td style="text-align: right">175.26</td>
      <td style="text-align: right">83.91</td>
      <td style="text-align: left">Middleweight</td>
    </tr>
    <tr>
      <td style="text-align: left">Kazushi “The Gracie Hunter” Sakuraba</td>
      <td style="text-align: left">26-17-1 (2 NC)</td>
      <td style="text-align: left">PRIDE (Past)</td>
      <td style="text-align: left">Male</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">1969-07-14</td>
      <td style="text-align: right">182.88</td>
      <td style="text-align: right">75.75</td>
      <td style="text-align: left">Welterweight</td>
    </tr>
    <tr>
      <td style="text-align: left">Ronda “Rowdy” Rousey</td>
      <td style="text-align: left">15-1</td>
      <td style="text-align: left">UFC (Current)</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: left">1987-02-01</td>
      <td style="text-align: right">167.64</td>
      <td style="text-align: right">61.23</td>
      <td style="text-align: left">Bantamweight</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1">## Fight-level data
</span><span class="n">bouts</span> <span class="o">&lt;-</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/processed_fight_data/MMA_all_bouts.Rds"</span><span class="p">)</span>

<span class="c1"># remove symmetrical pairs (i.e. only A-B, not A-B and B-A)
</span><span class="n">fighter_adjacency</span> <span class="o">&lt;-</span> <span class="n">bouts</span> <span class="o">%&gt;%</span>
  <span class="c1"># count matchups between each fighter and all opponents
</span>  <span class="n">count</span><span class="p">(</span><span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Opponent_link</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">rowwise</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="c1"># by combining Fighter_link and Opponent_link and then sorting, A-B and B-A
</span>  <span class="c1"># will have the same Paired_link
</span>  <span class="n">mutate</span><span class="p">(</span><span class="n">Paired_link</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Opponent_link</span><span class="p">)),</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s2">"-"</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="n">group_by</span><span class="p">(</span><span class="n">Paired_link</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># only take A-B or B-A, we only care about the link, not direction
</span>  <span class="n">slice</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">ungroup</span><span class="p">()</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_adjacency</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Fighter_link</th>
      <th style="text-align: left">Opponent_link</th>
      <th style="text-align: right">n</th>
      <th style="text-align: left">Paired_link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">/fighter/1651-1651-40638</td>
      <td style="text-align: left">/fighter/Akito-Oguchi-36825</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">/fighter/1651-1651-40638-/fighter/Akito-Oguchi-36825</td>
    </tr>
    <tr>
      <td style="text-align: left">/fighter/1651-1651-40638</td>
      <td style="text-align: left">/fighter/Takuya-Takahashi-81447</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">/fighter/1651-1651-40638-/fighter/Takuya-Takahashi-81447</td>
    </tr>
    <tr>
      <td style="text-align: left">/fighter/2Face-2Face-67592</td>
      <td style="text-align: left">/fighter/Tobizaru-Tobizaru-67593</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">/fighter/2Face-2Face-67592-/fighter/Tobizaru-Tobizaru-67593</td>
    </tr>
    <tr>
      <td style="text-align: left">/fighter/634-634-129431</td>
      <td style="text-align: left">/fighter/Nobuyuki-Tanioka-128927</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">/fighter/634-634-129431-/fighter/Nobuyuki-Tanioka-128927</td>
    </tr>
  </tbody>
</table>

<h2 id="summary-of-mma-fight-network">Summary of MMA fight network</h2>

<p>Matchups between fighters are reminiscent of <a href="https://en.wikipedia.org/wiki/Six_degrees_of_separation">six degrees of seperation</a>, an idea that most people can be connected by six or less steps: a friend of a friend of … of a friend. The suprisingly close proximity of seemingly random pairs of individuals is a common feature of social networks. This property is even more pronounced for the <a href="https://research.facebook.com/blog/three-and-a-half-degrees-of-separation/">facebook network</a>; where random users are seperated by an average of 3.5 friends.</p>

<p>We can look at the connectivity of MMA matchups in a similar way to see how many steps are between the average pair of fighters. To address this question, we can consider bouts as undirected edges that connect fighters and the whole set of fighters and bouts as an undirected network. Using  <a href="https://cran.r-project.org/web/packages/igraph/index.html">igraph</a> we can easily calculate the number of jumps between every pair of fighters in this network.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span>

<span class="c1"># turn the links between pairs of fighters into undirected edges
</span><span class="n">vital_graph</span> <span class="o">&lt;-</span> <span class="n">graph_from_data_frame</span><span class="p">(</span><span class="n">fighter_adjacency</span><span class="p">,</span> <span class="n">directed</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span> <span class="n">vertices</span> <span class="o">=</span> <span class="n">fighters</span><span class="p">)</span>

<span class="c1"># delete small disconnected groups
</span><span class="n">graph_clusters</span> <span class="o">&lt;-</span> <span class="n">clusters</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span>
<span class="n">disconnected_fighters</span> <span class="o">&lt;-</span> <span class="n">graph_clusters</span><span class="o">$</span><span class="n">membership</span><span class="p">[</span><span class="n">graph_clusters</span><span class="o">$</span><span class="n">membership</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">graph_clusters</span><span class="o">$</span><span class="n">no</span><span class="p">)[</span><span class="n">graph_clusters</span><span class="o">$</span><span class="n">csize</span> <span class="o">&lt;</span> <span class="m">100</span><span class="p">]]</span>
<span class="n">vital_graph</span> <span class="o">&lt;-</span> <span class="n">delete_vertices</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">,</span> <span class="n">which</span><span class="p">(</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">names</span><span class="p">(</span><span class="n">disconnected_fighters</span><span class="p">)))</span>

<span class="c1"># structural properties
</span>
<span class="n">network_mean_distance</span> <span class="o">=</span> <span class="n">mean_distance</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span>
<span class="n">network_diameter</span> <span class="o">=</span> <span class="n">diameter</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span></code></pre></figure>

<p>In comparison with most social networks, fighters are only loosely connected. The average number of bouts seperating fighters is 8.4 and the longest distance between any two fighters is 38.</p>

<p>To see why there are such large distances between fighters, we can project demographic factors (fighters’ locations, genders, weight classes …) onto the matchup network.</p>

<h2 id="major-factors-affecting-matchups">Major factors affecting matchups</h2>

<p>Thus far, we have considered the network of fighters (connected by bouts) which is defined solely by its connectivity. In order to visualize this network, we need to create a physical parallel between the network’s connectivity and the positions of fighters in physical space (i.e. each fighter has some [x,y] coordinates). While many approaches exist to produce such network layouts, the main goal of these approaches is to make it so that fighters who are closely connected in network space become closely connected in cartesian space. For this analysis, I will use the <a href="http://wiki.cns.iu.edu/pages/viewpage.action?pageId=1704113">DRL</a> force-directed layout algorithm, which is included in igraph. DRL works well on large datasets; it can generate a layout for this 150k node, 250k edge network in a couple of minutes.</p>

<p>Based on the network layout, we can expect that fighters who are closer together generally fight similar opponents. With this layout in hand, we can seperately project fighters’ weights, locale and gender onto the network to see how these factors affect matchups.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggraph</span><span class="p">)</span>

<span class="c1"># layout fighters using the DRL layout (good for large graphs)
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span>
<span class="n">vital_graph_xy</span> <span class="o">&lt;-</span> <span class="n">layout_with_drl</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span>
<span class="n">vital_graph_xy</span> <span class="o">&lt;-</span> <span class="n">as.data.frame</span><span class="p">(</span><span class="n">vital_graph_xy</span><span class="p">)</span>
<span class="n">colnames</span><span class="p">(</span><span class="n">vital_graph_xy</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">)</span>

<span class="c1"># generate a ggraph object with node coordinates (for ggplot2-based plotting)
</span><span class="n">gg_vital_graph</span> <span class="o">&lt;-</span> <span class="n">createLayout</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="s2">"manual"</span><span class="p">,</span> <span class="n">node.positions</span> <span class="o">=</span> <span class="n">vital_graph_xy</span><span class="p">)</span>

<span class="c1"># theme for network plots
</span><span class="n">graph_theme</span> <span class="o">&lt;-</span> <span class="n">theme_minimal</span><span class="p">()</span> <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">axis.text</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">panel.grid</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">axis.title</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">legend.key.size</span> <span class="o">=</span> <span class="n">unit</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="s2">"inches"</span><span class="p">),</span> <span class="n">legend.text</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">12</span><span class="p">),</span> <span class="n">legend.title</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">15</span><span class="p">),</span> <span class="n">plot.background</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="s2">"white"</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"white"</span><span class="p">),</span> <span class="n">text</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">),</span> <span class="n">strip.background</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"gray50"</span><span class="p">),</span> <span class="n">plot.title</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">20</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">Nation_region</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span> <span class="n">guides</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="n">guide_legend</span><span class="p">(</span><span class="n">override.aes</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">1</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">scale_color_manual</span><span class="p">(</span><span class="s2">"Region"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">region_colors</span><span class="o">$</span><span class="n">Nation_region</span><span class="p">,</span>
                     <span class="n">values</span> <span class="o">=</span> <span class="n">region_colors</span><span class="o">$</span><span class="n">Region_color</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Fighters colored by geographical region (based on nationality)"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-2-1.png" title="plot of chunk unnamed-chunk-2" alt="plot of chunk unnamed-chunk-2" style="display: block; margin: auto;" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">Weight_class</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span>
  <span class="n">scale_colour_gradientn</span><span class="p">(</span><span class="s2">"Weight Class"</span><span class="p">,</span> <span class="n">colours</span> <span class="o">=</span> <span class="n">rainbow</span><span class="p">(</span><span class="m">7</span><span class="p">),</span>
                         <span class="n">breaks</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">fighters</span><span class="o">$</span><span class="n">Weight_class</span><span class="p">)),</span>
                         <span class="n">labels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">(</span><span class="n">fighters</span><span class="o">$</span><span class="n">Weight_class</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Fighters colored by weight class"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-3-1.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" style="display: block; margin: auto;" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">Gender</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span> <span class="n">guides</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="n">guide_legend</span><span class="p">(</span><span class="n">override.aes</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">1</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">scale_color_brewer</span><span class="p">(</span><span class="s2">"Gender"</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="s2">"Set1"</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Fighters colored by gender (based on first name)"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" style="display: block; margin: auto;" /></p>

<p>Having looked at weight class, locale and gender, we can see that each attribute partially explains this network’s diffuse structure.</p>

<p>The regions where fighters come from structure the global fighter network into geographical blocks. Central American fighters are sandwiched between North American fighters and south american fighters. European fighters form a coherent group, although there is some finer structure, with regions of the graph that primarily contain Northern or Eastern European fighters. Asian countries form the other major cluster which also include Oceania: primarily Australia and New Zealand.</p>

<p>Weight class polarizes each region with one side primarily lighter weight classes and the other side largely heavier weight classes. Interestingly, the heaviest weight classes converge at the intersection of the major geographical categories, suggesting that heavy European, Asian and American fighters are more likely to compete than lighter fighters. This is likely because there are many more light fighters than heavy fighters so heavy fighters have an easier time making it onto the international scene.</p>

<p>Gender is another factor that majorly structures the fighter network. A note on this plot: because fighter genders were inferred by virtue of first names (and connectivity), the isolated pockets of red fighters in the blue network and blue in the red are likely just mislabelled. Male and female fighters form seperated subnetworks due to the almost total absence of cross-gender competition (interestingly, these graphs are connected).</p>

<p>With these three factors, we can explain the major trends in the network layout; however, this summary doesn’t give us a full idea of the distances seperating fighters.</p>

<h2 id="understanding-the-distances-between-fighters">Understanding the distances between fighters</h2>

<p>From the plots of geography, weight classes and gender, it seems that fighters are resolved into fairly tight groups by virtue of these three factors. While the diameter of this network (8.4) is large for a social network, it still seems small relative to the strong factors that structure fighters. To understand how two random fighters can be linked with only ~8 jumps, we need to consider how large differences in demographics are efficiently bridged by the network.</p>

<p>A likely way that such long distance jumps can be accomplished is through the top athletes of the sport. Top fighters have had many opponents, likely changed weight classes across their career and may have fought against athletes from other continents. Two methods of visualizing these top athletes should illustrate how these fighters can operate as hubs to facilitate long distance jumps.</p>

<h3 id="coloring-top-fighters-within-the-original-network">Coloring top fighters within the original network</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">top_fighers</span> <span class="o">&lt;-</span> <span class="n">fighters</span> <span class="o">%&gt;%</span> <span class="n">filter</span><span class="p">(</span><span class="n">UFC</span> <span class="o">!=</span> <span class="s2">"None"</span> <span class="o">|</span> <span class="n">Bellator</span> <span class="o">!=</span> <span class="s2">"None"</span> <span class="o">|</span> <span class="n">WSF</span> <span class="o">!=</span> <span class="s2">"None"</span> <span class="o">|</span> <span class="n">PRIDE</span> <span class="o">!=</span> <span class="s2">"None"</span><span class="p">)</span>

<span class="c1"># highlight UFC, WSF and Bellator fighters
</span><span class="n">gg_vital_graph</span><span class="o">$</span><span class="n">top</span> <span class="o">&lt;-</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">top_fighers</span><span class="o">$</span><span class="n">Query</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>

<span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">top</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="n">top</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span>
  <span class="n">scale_colour_manual</span><span class="p">(</span><span class="s2">"Tier"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">F</span><span class="p">),</span> <span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"RED"</span><span class="p">,</span> <span class="s2">"BLACK"</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Top"</span><span class="p">,</span> <span class="s2">"Rest"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">scale_alpha_manual</span><span class="p">(</span><span class="s2">"Tier"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">F</span><span class="p">),</span> <span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.02</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Top"</span><span class="p">,</span> <span class="s2">"Rest"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">guides</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="n">guide_legend</span><span class="p">(</span><span class="n">override.aes</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">8</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Highlighting ~2,000 UFC, WSF, PRIDE and Bellator fighters"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" style="display: block; margin: auto;" /></p>

<h3 id="coloring-top-fighters-within-their-own-network">Coloring top fighters within their own network</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">top_vital_graph</span> <span class="o">&lt;-</span> <span class="n">delete_vertices</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">,</span> <span class="n">which</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">top_fighers</span><span class="o">$</span><span class="n">Query</span><span class="p">)))</span>

<span class="n">top_vital_graph_xy</span> <span class="o">&lt;-</span> <span class="n">layout_with_drl</span><span class="p">(</span><span class="n">top_vital_graph</span><span class="p">)</span>
<span class="n">top_vital_graph_xy</span> <span class="o">&lt;-</span> <span class="n">as.data.frame</span><span class="p">(</span><span class="n">top_vital_graph_xy</span><span class="p">)</span>
<span class="n">colnames</span><span class="p">(</span><span class="n">top_vital_graph_xy</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">)</span>

<span class="n">top_gg_vital_graph</span> <span class="o">&lt;-</span> <span class="n">createLayout</span><span class="p">(</span><span class="n">top_vital_graph</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="s2">"manual"</span><span class="p">,</span> <span class="n">node.positions</span> <span class="o">=</span> <span class="n">top_vital_graph_xy</span><span class="p">)</span>

<span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">top_gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">Weight_class</span><span class="p">,</span>
                      <span class="n">Name</span> <span class="o">=</span> <span class="n">Display_name</span><span class="p">,</span>
                      <span class="n">Nationality</span> <span class="o">=</span> <span class="n">Nationality</span><span class="p">,</span>
                      <span class="n">WC</span> <span class="o">=</span> <span class="n">Weight_class</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span>
  <span class="n">scale_colour_gradientn</span><span class="p">(</span><span class="s2">"Weight Class"</span><span class="p">,</span> <span class="n">colours</span> <span class="o">=</span> <span class="n">rainbow</span><span class="p">(</span><span class="m">7</span><span class="p">),</span>
                         <span class="n">breaks</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">fighters</span><span class="o">$</span><span class="n">Weight_class</span><span class="p">)),</span>
                         <span class="n">labels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">(</span><span class="n">fighters</span><span class="o">$</span><span class="n">Weight_class</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Just looking at ~2,000 top fighters"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" style="display: block; margin: auto;" /></p>

<p>Looking at top fighters within our original layout, we see that their location is influenced by the same types of factors as all other MMA fighters: they form groups that are clustered according to weight class, locale and gender.</p>

<p>This structure is markedly different if we only look at a network composed of these top fighters. When only looking at top fighters, the primary factors that influence who-fights-who are weight class and gender. Note that this graph is more disconnected then when looking at all fighters: there is a subgraph for the major male fighters, the major female fighters, as well as many small groups of fighters who are not connected to the larger groups.</p>

<p>The difference between these two plots owes to the different phases of a top-tier MMA fighter’s career. All fighters have to start somewhere, so they will likely have multiple matches against fighters from their homeland. As they progress to higher-level competition, they will compete against more diverse opponents.</p>

<p>This suggests a model that could connect a random pair of fighter (F1 and F2): short range jumps connect F1 to an international fighter, jumps among international fighters traverse differences in weight class and locale, and another set of short range jumps ultimately reach F2. We can test this by visualizing the shortest paths connecting a set of random fighters</p>

<h2 id="visualizing-the-paths-between-fighters">Visualizing the paths between fighters</h2>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Choose npaths random pairs of vertices
</span><span class="n">npaths</span> <span class="o">&lt;-</span> <span class="m">5</span>
<span class="n">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
<span class="n">fighter_pairs</span> <span class="o">&lt;-</span> <span class="n">sapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">npaths</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">sample</span><span class="p">(</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span><span class="p">,</span> <span class="m">2</span><span class="p">)})</span>

<span class="c1"># find the shortest path between each pair
</span><span class="n">random_pairs</span> <span class="o">&lt;-</span> <span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">npaths</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
  <span class="n">get.shortest.paths</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">,</span> <span class="n">fighter_pairs</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="n">x</span><span class="p">],</span> <span class="n">fighter_pairs</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="n">x</span><span class="p">],</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">"all"</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s2">"both"</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1"># find the coordinates of fighters in the sequence
</span><span class="n">track_nodes</span> <span class="o">&lt;-</span> <span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">npaths</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">data.frame</span><span class="p">(</span><span class="n">set</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">fighter_seq</span> <span class="o">=</span> <span class="n">as_ids</span><span class="p">(</span><span class="n">random_pairs</span><span class="p">[[</span><span class="n">x</span><span class="p">]]</span><span class="o">$</span><span class="n">vpath</span><span class="p">[[</span><span class="m">1</span><span class="p">]]))})</span> <span class="o">%&gt;%</span>
  <span class="n">bind_rows</span> <span class="o">%&gt;%</span>
  <span class="n">group_by</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">step_num</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">())</span>
  
<span class="n">track_nodes_ids</span> <span class="o">&lt;-</span> <span class="n">data.frame</span><span class="p">(</span><span class="n">fighter_seq</span> <span class="o">=</span> <span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span><span class="p">[</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">track_nodes</span><span class="o">$</span><span class="n">fighter_seq</span><span class="p">],</span>
<span class="n">vital_graph_xy</span><span class="p">[</span><span class="n">V</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">track_nodes</span><span class="o">$</span><span class="n">fighter_seq</span><span class="p">,])</span>
  
<span class="n">track_nodes</span> <span class="o">&lt;-</span> <span class="n">track_nodes</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">track_nodes_ids</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"fighter_seq"</span><span class="p">)</span>

<span class="c1"># find the coordinates of the edges
</span><span class="n">track_edges</span> <span class="o">&lt;-</span> <span class="n">lapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">npaths</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">data.frame</span><span class="p">(</span><span class="n">set</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">get.edges</span><span class="p">(</span><span class="n">vital_graph</span><span class="p">,</span> <span class="n">random_pairs</span><span class="p">[[</span><span class="n">x</span><span class="p">]]</span><span class="o">$</span><span class="n">epath</span><span class="p">[[</span><span class="m">1</span><span class="p">]]))})</span> <span class="o">%&gt;%</span> <span class="n">bind_rows</span>

<span class="n">track_edges_coords</span> <span class="o">&lt;-</span> <span class="n">data.frame</span><span class="p">(</span><span class="n">set</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">track_edges</span><span class="o">$</span><span class="n">set</span><span class="p">),</span>
           <span class="n">x</span> <span class="o">=</span> <span class="n">vital_graph_xy</span><span class="o">$</span><span class="n">x</span><span class="p">[</span><span class="n">track_edges</span><span class="o">$</span><span class="n">X1</span><span class="p">],</span>
           <span class="n">xend</span> <span class="o">=</span> <span class="n">vital_graph_xy</span><span class="o">$</span><span class="n">x</span><span class="p">[</span><span class="n">track_edges</span><span class="o">$</span><span class="n">X2</span><span class="p">],</span>
           <span class="n">y</span> <span class="o">=</span> <span class="n">vital_graph_xy</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">track_edges</span><span class="o">$</span><span class="n">X1</span><span class="p">],</span>
           <span class="n">yend</span> <span class="o">=</span> <span class="n">vital_graph_xy</span><span class="o">$</span><span class="n">y</span><span class="p">[</span><span class="n">track_edges</span><span class="o">$</span><span class="n">X2</span><span class="p">])</span>

<span class="c1"># for repelling text
</span><span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">)</span>

<span class="n">ggraph</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">gg_vital_graph</span><span class="p">)</span> <span class="o">+</span> 
  <span class="n">geom_node_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">top</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="n">top</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_edge_link</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">track_edges_coords</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">xend</span> <span class="o">=</span> <span class="n">xend</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">yend</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="n">set</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">set</span><span class="p">),</span> <span class="n">edge_width</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">geom_label_repel</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">track_nodes</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">step_num</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">set</span><span class="p">)),</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">5</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">graph_theme</span> <span class="o">+</span>
  <span class="n">scale_colour_manual</span><span class="p">(</span><span class="s2">"Tier"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">F</span><span class="p">),</span> <span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"RED"</span><span class="p">,</span> <span class="s2">"BLACK"</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Top"</span><span class="p">,</span> <span class="s2">"Rest"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">scale_alpha_manual</span><span class="p">(</span><span class="s2">"Tier"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">F</span><span class="p">),</span> <span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.02</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Top"</span><span class="p">,</span> <span class="s2">"Rest"</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">guides</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="n">guide_legend</span><span class="p">(</span><span class="n">override.aes</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">8</span><span class="p">)))</span> <span class="o">+</span>
  <span class="n">scale_edge_colour_brewer</span><span class="p">(</span><span class="s2">"Random fighter pairs"</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="s2">"Set2"</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_fill_brewer</span><span class="p">(</span><span class="s2">"Random fighter pairs"</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="s2">"Set2"</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Paths between random pairs of fighters"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-17-smallWorldMMA/unnamed-chunk-7-1.png" title="plot of chunk unnamed-chunk-7" alt="plot of chunk unnamed-chunk-7" style="display: block; margin: auto;" /></p>

<p>Looking at a set of representative paths between random fighters, we see the pattern that I suggested above emerge: fighters usually require multiple jumps to reach well-connected fighters; these well-connected fighters make distant jumps across weight classes and regions; finally, the destination fighter also likely requires several local jumps.</p>

<p>Two factors contribute to the not-so-small-world network of MMA fighers: the relatively low number of connections of most fighters (leading to short local jumps to reach hubs), and broad demographic differences among fighters (requiring long distance jumps across demographics). The great distances between fighters are primarily due to low connectivity; all social networks contain barriers, and the MMA network is an extreme but likely not unprecedented example. Nevertheless, these barriers clearly impose a strong structure on the MMA fighting community where competitions are greatly structured based on geography, weight, gender and experience.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://www.fightprior.com/2016/05/13/summarizingFighters/">
        Building a large database of MMA fight results III: summarizing the demographics of 140,000 MMA fighters
      </a>
    </h1>

    <span class="post-date">13 May 2016</span>

    <p>The essential units of analysis in MMA are the sport’s fighters and the bouts between them. In my <a href="http://www.fightprior.com/2016/05/05/summarizingFights/">previous post</a>, I discussed how to standardize match data so that the major categories of finishes could be easily visualized.</p>

<p>In this entry, I will discuss how to clean-up fighter-level data. The main goal of this post will be to determine the factors that affect fighter matchups. For some fighters, our data contains useful demographics, while for other fighters, this information is missing. One goal of this post will be to infer missing demographic data based on fighters’ previous bouts. For example, if we don’t know where in the world a fighter lives, we can probably determine their location with good accuracy if all their fights have been against people from the same region.</p>

<p>The data that we will primarily work with was collected seperately for each fighter. We will first combine fighters’ data into a single table that can be more easily used.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/raw_fight_data/fighter_output.Rdata"</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">vital_stats</span><span class="p">,</span> <span class="n">row.names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">Nickname</th>
      <th style="text-align: left">Birthday</th>
      <th style="text-align: right">Height</th>
      <th style="text-align: right">Weight</th>
      <th style="text-align: left">nationality</th>
      <th style="text-align: left">weight_class</th>
      <th style="text-align: left">camp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei Arlovski</td>
      <td style="text-align: left">The Pit Bull</td>
      <td style="text-align: left">1979-02-04</td>
      <td style="text-align: right">193.04</td>
      <td style="text-align: right">109.32</td>
      <td style="text-align: left">Belarus</td>
      <td style="text-align: left">Heavyweight</td>
      <td style="text-align: left">Jackson-Wink MMA</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">fighter_vital_statistics</span> <span class="o">&lt;-</span> <span class="n">bind_rows</span><span class="p">(</span><span class="n">lapply</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">x</span><span class="o">$</span><span class="n">vital_stats</span><span class="p">}))</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">Query</span> <span class="o">=</span> <span class="n">names</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="n">tbl_df</span><span class="p">()</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_vital_statistics</span><span class="p">),</span> <span class="n">row.names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">Nickname</th>
      <th style="text-align: left">Birthday</th>
      <th style="text-align: right">Height</th>
      <th style="text-align: right">Weight</th>
      <th style="text-align: left">nationality</th>
      <th style="text-align: left">weight_class</th>
      <th style="text-align: left">camp</th>
      <th style="text-align: left">Query</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei Arlovski</td>
      <td style="text-align: left">The Pit Bull</td>
      <td style="text-align: left">1979-02-04</td>
      <td style="text-align: right">193.04</td>
      <td style="text-align: right">109.32</td>
      <td style="text-align: left">Belarus</td>
      <td style="text-align: left">Heavyweight</td>
      <td style="text-align: left">Jackson-Wink MMA</td>
      <td style="text-align: left">/fighter/Andrei-Arlovski-270</td>
    </tr>
    <tr>
      <td style="text-align: left">Ikuhisa Minowa</td>
      <td style="text-align: left">Minowaman</td>
      <td style="text-align: left">1976-01-12</td>
      <td style="text-align: right">175.26</td>
      <td style="text-align: right">83.91</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">Middleweight</td>
      <td style="text-align: left">Kuma Gym</td>
      <td style="text-align: left">/fighter/Ikuhisa-Minowa-250</td>
    </tr>
    <tr>
      <td style="text-align: left">Kazushi Sakuraba</td>
      <td style="text-align: left">The Gracie Hunter</td>
      <td style="text-align: left">1969-07-14</td>
      <td style="text-align: right">182.88</td>
      <td style="text-align: right">75.75</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">Welterweight</td>
      <td style="text-align: left">Laughter7</td>
      <td style="text-align: left">/fighter/Kazushi-Sakuraba-84</td>
    </tr>
    <tr>
      <td style="text-align: left">Ronda Rousey</td>
      <td style="text-align: left">Rowdy</td>
      <td style="text-align: left">1987-02-01</td>
      <td style="text-align: right">167.64</td>
      <td style="text-align: right">61.23</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: left">Bantamweight</td>
      <td style="text-align: left">Team Hayastan</td>
      <td style="text-align: left">/fighter/Ronda-Rousey-73073</td>
    </tr>
    <tr>
      <td style="text-align: left">B.J. Penn</td>
      <td style="text-align: left">The Prodigy</td>
      <td style="text-align: left">1978-12-13</td>
      <td style="text-align: right">175.26</td>
      <td style="text-align: right">65.77</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: left">Featherweight</td>
      <td style="text-align: left">BJ Penn’s MMA</td>
      <td style="text-align: left">/fighter/BJ-Penn-1307</td>
    </tr>
    <tr>
      <td style="text-align: left">Thales Trindade</td>
      <td style="text-align: left">Pezao</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: left">Brazil</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">/fighter/Thales-Trindade-166551</td>
    </tr>
  </tbody>
</table>

<h3 id="summarizing-fighter-demographics-gender-weight-and-locale">Summarizing fighter demographics: gender, weight and locale</h3>

<p>For many fighters, our dataset contains important fighter attributes such as nationality, weight class and age. One attribute that is noticeably absent is gender. If we are interested in the factors affecting who-fights-who in MMA, then gender is definitely important.</p>

<p>One method that we can use to try to predict the genders of fighters is to look at the gender that is generally associated with a fighter’s first name. The <a href="https://cran.rstudio.com/web/packages/gender/">gender</a> provides great resources for exactly this task. Using the “ssa” method, which looks at Social Security Administration baby names, for each first name, we can determine the fraction of male babies and the fraction of female babies with the name.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">fighter_names</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Query</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">rowwise</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">mutate</span><span class="p">(</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">strsplit</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">split</span> <span class="o">=</span> <span class="s2">" "</span><span class="p">)[[</span><span class="m">1</span><span class="p">]][</span><span class="m">1</span><span class="p">])</span>

<span class="n">gender_prediction</span> <span class="o">&lt;-</span> <span class="n">gender</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">fighter_names</span><span class="o">$</span><span class="n">first_name</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">"ssa"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">tbl_df</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">Pr_male</span> <span class="o">=</span> <span class="n">proportion_male</span><span class="p">)</span>

<span class="n">fighter_names</span> <span class="o">&lt;-</span> <span class="n">fighter_names</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">gender_prediction</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"first_name"</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_names</span><span class="p">),</span> <span class="n">row.names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">Query</th>
      <th style="text-align: left">first_name</th>
      <th style="text-align: right">Pr_male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei Arlovski</td>
      <td style="text-align: left">/fighter/Andrei-Arlovski-270</td>
      <td style="text-align: left">Andrei</td>
      <td style="text-align: right">1.0000</td>
    </tr>
    <tr>
      <td style="text-align: left">Ikuhisa Minowa</td>
      <td style="text-align: left">/fighter/Ikuhisa-Minowa-250</td>
      <td style="text-align: left">Ikuhisa</td>
      <td style="text-align: right">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Kazushi Sakuraba</td>
      <td style="text-align: left">/fighter/Kazushi-Sakuraba-84</td>
      <td style="text-align: left">Kazushi</td>
      <td style="text-align: right">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Ronda Rousey</td>
      <td style="text-align: left">/fighter/Ronda-Rousey-73073</td>
      <td style="text-align: left">Ronda</td>
      <td style="text-align: right">0.0083</td>
    </tr>
    <tr>
      <td style="text-align: left">B.J. Penn</td>
      <td style="text-align: left">/fighter/BJ-Penn-1307</td>
      <td style="text-align: left">B.J.</td>
      <td style="text-align: right">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Thales Trindade</td>
      <td style="text-align: left">/fighter/Thales-Trindade-166551</td>
      <td style="text-align: left">Thales</td>
      <td style="text-align: right">1.0000</td>
    </tr>
  </tbody>
</table>

<p>Classifying names works for the majority of fighters, but for 8% of fighters predicted gender is clearly ambiguous (0.1 &lt; Pr(Male) &lt; 0.9), while for 
11% of fighters no gender prediction is possible at all.</p>

<p>In addition to gender, we would like to summarize each fighter’s weight class and where he/she is from. To summarize where fighters are from, nationality may be too specific for some purposes (there are 193 countries in the UN). To provide a less specific summary of fighters’ locations, we can use the <a href="https://cran.r-project.org/web/packages/countrycode/index.html">countrycode</a> package. Countrycode provides mappings between countries and regions. We can then also manually add the continents in which these regions fall.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">countrycode</span><span class="p">)</span>

<span class="c1"># Define regions
</span><span class="n">nationality_summary</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span> <span class="n">count</span><span class="p">(</span><span class="n">nationality</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">nation_region</span> <span class="o">=</span> <span class="n">countrycode</span><span class="p">(</span><span class="n">nationality</span><span class="p">,</span> <span class="s2">"country.name"</span><span class="p">,</span> <span class="s2">"region"</span><span class="p">))</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">[</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nationality</span> <span class="o">==</span> <span class="s2">"Taiwan"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s2">"Eastern Asia"</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">[</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Melanesia"</span><span class="p">,</span> <span class="s2">"Micronesia"</span><span class="p">,</span> <span class="s2">"Polynesia"</span><span class="p">,</span> <span class="s2">"Australia and New Zealand"</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"Oceania"</span>

<span class="c1"># Define continents
</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span> <span class="o">&lt;-</span> <span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span><span class="p">[</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Caribbean"</span><span class="p">,</span> <span class="s2">"Northern America"</span><span class="p">,</span> <span class="s2">"Central America"</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"N. America"</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span><span class="p">[</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">c</span><span class="p">(</span><span class="s2">"South America"</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"S. America"</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span><span class="p">[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Africa'</span><span class="p">,</span> <span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"Africa"</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span><span class="p">[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Europe'</span><span class="p">,</span> <span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"Europe"</span>
<span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_continent</span><span class="p">[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Asia'</span><span class="p">,</span> <span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"Asia"</span>

<span class="c1"># overwrite misspelled nationalities
</span><span class="n">fighter_vital_statistics</span><span class="o">$</span><span class="n">nationality</span><span class="p">[</span><span class="n">fighter_vital_statistics</span><span class="o">$</span><span class="n">nationality</span> <span class="o">%</span><span class="k">in</span><span class="o">%</span> <span class="n">nationality_summary</span><span class="o">$</span><span class="n">nationality</span><span class="p">[</span><span class="n">is.na</span><span class="p">(</span><span class="n">nationality_summary</span><span class="o">$</span><span class="n">nation_region</span><span class="p">)]]</span> <span class="o">&lt;-</span> <span class="n">NA</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">nationality_summary</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">nationality</th>
      <th style="text-align: right">n</th>
      <th style="text-align: left">nation_region</th>
      <th style="text-align: left">nation_continent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">165</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">185</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Afganistan</td>
      <td style="text-align: right">1</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Afghanistan</td>
      <td style="text-align: right">98</td>
      <td style="text-align: left">Southern Asia</td>
      <td style="text-align: left">Asia</td>
    </tr>
    <tr>
      <td style="text-align: left">Albania</td>
      <td style="text-align: right">13</td>
      <td style="text-align: left">Southern Europe</td>
      <td style="text-align: left">Europe</td>
    </tr>
    <tr>
      <td style="text-align: left">Algeria</td>
      <td style="text-align: right">10</td>
      <td style="text-align: left">Northern Africa</td>
      <td style="text-align: left">Africa</td>
    </tr>
  </tbody>
</table>

<p>Based on our starting weight class and nationality data along with the genders that were inferred based on names, we have complete data for 49% of fighters. We can be confident in weight class (although this does change across fighters’ careers). We are less confident, however, in the inferred gender because there are many cases of ambigously predicted genders.</p>

<h3 id="network-based-imputation-of-fighter-demographics">Network-based imputation of fighter demographics</h3>

<p>To improve our prediction of fighters’ locale, weight class and gender, we can use an additional important source of information: their matchups with other fighters. Fighters are likely to fight people who are a similar weight, the same gender and who reside in a similar location.</p>

<p>Our strategy is to capitalize on bout information to label fighters’ unknown attributes (and gender, as this may be mispredicted by name), according to a consensus of fighters’ neighbors. This approach is implemented as an iterative algorithm. During one iteration, we start with bout data (fighter-opponent) and fill in the opponent demographics. Then a consensus of opponents’ demographics is taken for each fighter and the fighter’s attributes are updated if they were previously unknown. After each iteration we learn more about opponents’ demographics (if they were missing); this information is then passed onto fighters until we are left with only ambiguous attributes.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># load bout data
</span><span class="n">all_bouts</span> <span class="o">&lt;-</span> <span class="n">readRDS</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/processed_fight_data/MMA_all_bouts.Rds"</span><span class="p">)</span>

<span class="n">fighter_vital_network_V</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="n">weight_class</span><span class="p">,</span> <span class="n">nationality</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">fighter_names</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Query"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">nationality_summary</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"nationality"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">Pr_male_impute</span> <span class="o">=</span> <span class="n">Pr_male</span><span class="p">,</span>
         <span class="n">weight_class_impute</span> <span class="o">=</span> <span class="n">weight_class</span><span class="p">,</span>
         <span class="n">nationality_impute</span> <span class="o">=</span> <span class="n">nationality</span><span class="p">,</span>
         <span class="n">nation_region_impute</span> <span class="o">=</span> <span class="n">nation_region</span><span class="p">,</span>
         <span class="n">nation_continent_impute</span> <span class="o">=</span> <span class="n">nation_continent</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_vital_network_V</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">Pr_male</span><span class="p">,</span> <span class="n">Pr_male_impute</span><span class="p">,</span> <span class="n">weight_class</span><span class="p">,</span> <span class="n">weight_class_impute</span><span class="p">,</span> <span class="n">nationality</span><span class="p">,</span> <span class="n">nationality_impute</span><span class="p">)),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">first_name</th>
      <th style="text-align: right">Pr_male</th>
      <th style="text-align: right">Pr_male_impute</th>
      <th style="text-align: left">weight_class</th>
      <th style="text-align: left">weight_class_impute</th>
      <th style="text-align: left">nationality</th>
      <th style="text-align: left">nationality_impute</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei Arlovski</td>
      <td style="text-align: left">Andrei</td>
      <td style="text-align: right">1.0000</td>
      <td style="text-align: right">1.0000</td>
      <td style="text-align: left">Heavyweight</td>
      <td style="text-align: left">Heavyweight</td>
      <td style="text-align: left">Belarus</td>
      <td style="text-align: left">Belarus</td>
    </tr>
    <tr>
      <td style="text-align: left">Ikuhisa Minowa</td>
      <td style="text-align: left">Ikuhisa</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: left">Middleweight</td>
      <td style="text-align: left">Middleweight</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">Japan</td>
    </tr>
    <tr>
      <td style="text-align: left">Kazushi Sakuraba</td>
      <td style="text-align: left">Kazushi</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: left">Welterweight</td>
      <td style="text-align: left">Welterweight</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: left">Japan</td>
    </tr>
    <tr>
      <td style="text-align: left">Ronda Rousey</td>
      <td style="text-align: left">Ronda</td>
      <td style="text-align: right">0.0083</td>
      <td style="text-align: right">0.0083</td>
      <td style="text-align: left">Bantamweight</td>
      <td style="text-align: left">Bantamweight</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: left">United States</td>
    </tr>
    <tr>
      <td style="text-align: left">B.J. Penn</td>
      <td style="text-align: left">B.J.</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: right">NA</td>
      <td style="text-align: left">Featherweight</td>
      <td style="text-align: left">Featherweight</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: left">United States</td>
    </tr>
    <tr>
      <td style="text-align: left">Thales Trindade</td>
      <td style="text-align: left">Thales</td>
      <td style="text-align: right">1.0000</td>
      <td style="text-align: right">1.0000</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">Brazil</td>
      <td style="text-align: left">Brazil</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Look at all opponents
</span><span class="n">fighter_vital_network_E</span> <span class="o">&lt;-</span> <span class="n">all_bouts</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Opponent_link</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">unique</span><span class="p">()</span>
<span class="n">fighter_vital_network_E</span> <span class="o">&lt;-</span> <span class="n">rbind</span><span class="p">(</span><span class="n">fighter_vital_network_E</span><span class="p">,</span> <span class="n">fighter_vital_network_E</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Opponent_link</span> <span class="o">=</span> <span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Fighter_link</span> <span class="o">=</span> <span class="n">Opponent_link</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="n">unique</span><span class="p">()</span>

<span class="c1"># Add known attributes of query fighter (fighter link)
</span><span class="n">fighter_vital_network_E</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_network_E</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">fighter_vital_network_V</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Fighter_link</span> <span class="o">=</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Pr_male</span><span class="p">,</span> <span class="n">weight_class</span><span class="p">,</span> <span class="n">nationality</span><span class="p">,</span> <span class="n">nation_region</span><span class="p">,</span> <span class="n">nation_continent</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Fighter_link"</span><span class="p">)</span>
<span class="c1"># Add consensus estimate of opponent attributes (opponent_link)
</span><span class="n">fighter_vital_network_E</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_network_E</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">fighter_vital_network_V</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Opponent_link</span> <span class="o">=</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Pr_male_impute</span><span class="o">:</span><span class="n">nation_continent_impute</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Opponent_link"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># determine the top match from neighbors
</span><span class="n">get_max</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="n">all</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">))){</span>
    <span class="k">return</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">NA_character_</span><span class="p">))</span> 
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">x</span> <span class="o">%&gt;%</span> <span class="n">table</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">sort</span><span class="p">(</span><span class="n">decreasing</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">names</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">first</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="k">return</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># so that we can track missing values as the algorithm proceeds
</span><span class="n">count_na</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
 <span class="n">sum</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
<span class="p">}</span>

<span class="c1"># track number of missing values throughout iteration
</span>
<span class="n">iter_count</span> <span class="o">&lt;-</span> <span class="m">0</span>
<span class="n">track_fill_in</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_network_V</span> <span class="o">%&gt;%</span> <span class="n">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">summarize_each</span><span class="p">(</span><span class="n">funs</span><span class="p">(</span><span class="n">count_na</span><span class="p">),</span> <span class="n">Pr_male_impute</span><span class="o">:</span><span class="n">nation_continent_impute</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">mutate</span><span class="p">(</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iter_count</span><span class="p">)</span>

<span class="k">repeat</span><span class="p">{</span>
  <span class="n">iter_count</span> <span class="o">&lt;-</span> <span class="n">iter_count</span><span class="m">+1</span>
  
  <span class="c1"># infer demographics based on neighborhood
</span>  <span class="c1"># for weight class and locations, find the most frequent neighbor class
</span>  <span class="c1"># for gender [0,1] average Pr(male)
</span>  
  <span class="n">update_fighter_vitals</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_network_E</span> <span class="o">%&gt;%</span>
    <span class="n">group_by</span><span class="p">(</span><span class="n">Fighter_link</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="n">summarize</span><span class="p">(</span><span class="n">Pr_male</span> <span class="o">=</span> <span class="n">Pr_male</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
              <span class="n">weight_class</span> <span class="o">=</span> <span class="n">weight_class</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
              <span class="n">nationality</span> <span class="o">=</span> <span class="n">nationality</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
              <span class="n">nation_region</span> <span class="o">=</span> <span class="n">nation_region</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
              <span class="n">nation_continent</span> <span class="o">=</span> <span class="n">nation_continent</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
              <span class="n">Pr_male_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">all</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">Pr_male_impute</span><span class="p">)),</span> <span class="n">NA</span><span class="p">,</span> <span class="n">mean</span><span class="p">(</span><span class="n">Pr_male_impute</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="n">T</span><span class="p">)),</span>
              <span class="n">weight_class_impute</span> <span class="o">=</span> <span class="n">get_max</span><span class="p">(</span><span class="n">weight_class_impute</span><span class="p">),</span>
              <span class="n">nationality_impute</span> <span class="o">=</span> <span class="n">get_max</span><span class="p">(</span><span class="n">nationality_impute</span><span class="p">),</span>
              <span class="n">nation_region_impute</span> <span class="o">=</span> <span class="n">get_max</span><span class="p">(</span><span class="n">nation_region_impute</span><span class="p">),</span>
              <span class="n">nation_continent_impute</span> <span class="o">=</span> <span class="n">get_max</span><span class="p">(</span><span class="n">nation_continent_impute</span><span class="p">))</span>
  
  <span class="n">track_fill_in</span> <span class="o">&lt;-</span> <span class="n">rbind</span><span class="p">(</span><span class="n">track_fill_in</span><span class="p">,</span>
                         <span class="n">update_fighter_vitals</span> <span class="o">%&gt;%</span> <span class="n">summarize_each</span><span class="p">(</span><span class="n">funs</span><span class="p">(</span><span class="n">count_na</span><span class="p">),</span> <span class="n">Pr_male_impute</span><span class="o">:</span><span class="n">nation_continent_impute</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">mutate</span><span class="p">(</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iter_count</span><span class="p">)</span>
  <span class="p">)</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">iter_count</span> <span class="o">&gt;</span> <span class="m">9</span><span class="p">){</span>
    <span class="k">break</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    
    <span class="c1"># overwrite known demographics during each iteration
</span>    <span class="n">update_fighter_vitals</span> <span class="o">&lt;-</span> <span class="n">update_fighter_vitals</span> <span class="o">%&gt;%</span>
      <span class="n">mutate</span><span class="p">(</span><span class="n">Pr_male_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">Pr_male</span><span class="p">),</span> <span class="n">Pr_male_impute</span><span class="p">,</span> <span class="n">Pr_male</span><span class="p">),</span>
             <span class="n">weight_class_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">weight_class</span><span class="p">),</span> <span class="n">weight_class_impute</span><span class="p">,</span> <span class="n">weight_class</span><span class="p">),</span>
             <span class="n">nationality_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nationality</span><span class="p">),</span> <span class="n">nationality_impute</span><span class="p">,</span> <span class="n">nationality</span><span class="p">),</span>
             <span class="n">nation_region_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nation_region</span><span class="p">),</span> <span class="n">nation_region_impute</span><span class="p">,</span> <span class="n">nation_region</span><span class="p">),</span>
             <span class="n">nation_continent_impute</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nation_continent</span><span class="p">),</span> <span class="n">nation_continent_impute</span><span class="p">,</span> <span class="n">nation_continent</span><span class="p">))</span>
    
    <span class="n">fighter_vital_network_E</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_network_E</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Fighter_link</span><span class="o">:</span><span class="n">nation_continent</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="n">left_join</span><span class="p">(</span><span class="n">update_fighter_vitals</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Opponent_link</span> <span class="o">=</span> <span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Pr_male_impute</span><span class="o">:</span><span class="n">nation_continent_impute</span><span class="p">),</span>
                <span class="n">by</span> <span class="o">=</span> <span class="s2">"Opponent_link"</span><span class="p">)</span>
    
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">fighter_vital_consensus</span> <span class="o">&lt;-</span> <span class="n">update_fighter_vitals</span> <span class="o">%&gt;%</span> <span class="n">rowwise</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">Gender</span> <span class="o">=</span> <span class="k">if</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">Pr_male_impute</span><span class="p">)){</span><span class="n">NA_character_</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">Pr_male_impute</span> <span class="o">&lt;</span> <span class="m">0.2</span><span class="p">){</span><span class="s2">"Female"</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">Pr_male_impute</span> <span class="o">&gt;</span> <span class="m">0.8</span><span class="p">){</span><span class="s2">"Male"</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="n">NA_character_</span><span class="p">},</span>
         <span class="n">Weight_class</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">weight_class</span><span class="p">),</span> <span class="n">weight_class_impute</span><span class="p">,</span> <span class="n">weight_class</span><span class="p">),</span>
         <span class="n">Nationality</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nationality</span><span class="p">),</span> <span class="n">nationality_impute</span><span class="p">,</span> <span class="n">nationality</span><span class="p">),</span>
         <span class="n">Nation_region</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nation_region</span><span class="p">),</span> <span class="n">nation_region_impute</span><span class="p">,</span> <span class="n">nation_region</span><span class="p">),</span>
         <span class="n">Nation_continent</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">is.na</span><span class="p">(</span><span class="n">nation_continent</span><span class="p">),</span> <span class="n">nation_continent_impute</span><span class="p">,</span> <span class="n">nation_continent</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">Query</span> <span class="o">=</span> <span class="n">Fighter_link</span><span class="p">,</span> <span class="n">Gender</span><span class="o">:</span><span class="n">Nation_continent</span><span class="p">)</span>
  
<span class="n">fighter_vital_statistics</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="n">Name</span><span class="o">:</span><span class="n">Weight</span><span class="p">,</span> <span class="n">Camp</span> <span class="o">=</span> <span class="n">camp</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">fighter_vital_consensus</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Query"</span><span class="p">)</span></code></pre></figure>

<p>As the imputation algorithm proceeds, we are able to fill in a large amount of missing information. This method should accurately predict unknown genders, weight classes and the general locale of fighters (inferred nationalities are more uncertain in many cases).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">kable</span><span class="p">(</span><span class="n">track_fill_in</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Pr_male_impute</th>
      <th style="text-align: right">weight_class_impute</th>
      <th style="text-align: right">nationality_impute</th>
      <th style="text-align: right">nation_region_impute</th>
      <th style="text-align: right">nation_continent_impute</th>
      <th style="text-align: right">iteration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">15890</td>
      <td style="text-align: right">55810</td>
      <td style="text-align: right">42317</td>
      <td style="text-align: right">42317</td>
      <td style="text-align: right">42317</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: right">8719</td>
      <td style="text-align: right">26693</td>
      <td style="text-align: right">20429</td>
      <td style="text-align: right">20429</td>
      <td style="text-align: right">20429</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">820</td>
      <td style="text-align: right">13393</td>
      <td style="text-align: right">9595</td>
      <td style="text-align: right">9595</td>
      <td style="text-align: right">9595</td>
      <td style="text-align: right">2</td>
    </tr>
    <tr>
      <td style="text-align: right">688</td>
      <td style="text-align: right">11144</td>
      <td style="text-align: right">7775</td>
      <td style="text-align: right">7775</td>
      <td style="text-align: right">7775</td>
      <td style="text-align: right">3</td>
    </tr>
    <tr>
      <td style="text-align: right">671</td>
      <td style="text-align: right">10680</td>
      <td style="text-align: right">7412</td>
      <td style="text-align: right">7412</td>
      <td style="text-align: right">7412</td>
      <td style="text-align: right">4</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10576</td>
      <td style="text-align: right">7338</td>
      <td style="text-align: right">7338</td>
      <td style="text-align: right">7338</td>
      <td style="text-align: right">5</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10551</td>
      <td style="text-align: right">7319</td>
      <td style="text-align: right">7319</td>
      <td style="text-align: right">7319</td>
      <td style="text-align: right">6</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10546</td>
      <td style="text-align: right">7312</td>
      <td style="text-align: right">7312</td>
      <td style="text-align: right">7312</td>
      <td style="text-align: right">7</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10544</td>
      <td style="text-align: right">7308</td>
      <td style="text-align: right">7308</td>
      <td style="text-align: right">7308</td>
      <td style="text-align: right">8</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10542</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">9</td>
    </tr>
    <tr>
      <td style="text-align: right">670</td>
      <td style="text-align: right">10542</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">7307</td>
      <td style="text-align: right">10</td>
    </tr>
  </tbody>
</table>

<h3 id="summary-of-fighter-demographics">Summary of fighter demographics</h3>

<p>As a quick summary of cleaned-up fighter-specific data, we can look at summaries of two major types of fighter demographics: fighter weight classes and where fighters live.</p>

<p>First we will look at weight classes. Because weight classes are ordered, with Atomweight the lightest and Super Heavyweight the heaviest, weight categories were sorted according to their logical progression and the frequency of fighters in each weight class was determined</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="n">weight_summary</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Weight_class</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">Weight_class</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">mutate</span><span class="p">(</span><span class="n">Weight_class</span> <span class="o">=</span> <span class="n">ordered</span><span class="p">(</span><span class="n">Weight_class</span><span class="p">,</span>
                                <span class="n">levels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Atomweight"</span><span class="p">,</span> <span class="s2">"Strawweight"</span><span class="p">,</span> <span class="s2">"Flyweight"</span><span class="p">,</span> <span class="s2">"Bantamweight"</span><span class="p">,</span>
                                           <span class="s2">"Featherweight"</span><span class="p">,</span> <span class="s2">"Lightweight"</span><span class="p">,</span> <span class="s2">"Welterweight"</span><span class="p">,</span> <span class="s2">"Middleweight"</span><span class="p">,</span>
                                           <span class="s2">"Light Heavyweight"</span><span class="p">,</span> <span class="s2">"Heavyweight"</span><span class="p">,</span> <span class="s2">"Super Heavyweight"</span><span class="p">)))</span> <span class="o">%&gt;%</span>
  <span class="n">arrange</span><span class="p">(</span><span class="n">Weight_class</span><span class="p">)</span>

<span class="c1"># ggplot2 plotting theme
</span><span class="n">hist_theme</span> <span class="o">&lt;-</span> <span class="n">theme</span><span class="p">(</span><span class="n">axis.title</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">25</span><span class="p">),</span>
                    <span class="n">panel.background</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="s2">"gray93"</span><span class="p">),</span>
                    <span class="n">panel.border</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">),</span>
                    <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span>
                    <span class="n">panel.grid.major.x</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span>
                    <span class="n">panel.grid.major.y</span> <span class="o">=</span> <span class="n">element_line</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"gray70"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">),</span>
                    <span class="n">axis.text</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">18</span><span class="p">,</span> <span class="n">hjust</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">vjust</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span>
                    <span class="n">axis.text.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">angle</span> <span class="o">=</span> <span class="m">90</span><span class="p">,</span> <span class="n">hjust</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">vjust</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span>
                    <span class="n">axis.ticks</span> <span class="o">=</span> <span class="n">element_line</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">),</span>
                    <span class="n">axis.ticks.length</span> <span class="o">=</span> <span class="n">unit</span><span class="p">(</span><span class="m">0.15</span><span class="p">,</span> <span class="s2">"cm"</span><span class="p">))</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">weight_summary</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Weight_class</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="s2">"identity"</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="s2">"firebrick"</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">hist_theme</span> <span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Counts"</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="s2">"Weight Class"</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-13-summarizingFighters/unnamed-chunk-3-1.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" style="display: block; margin: auto;" /></p>

<p>Looking at weight classes: most fighters compete at intermediate weight classes; the most common weight classes are Lightweight and Welterweight.</p>

<p>The geographical summaries that we generated: nationality, region and continent are a nested hierarchy with nations residing within regions and regions within continents. To make use of this hierarchy for visualization we need to make sure that this nested structure is maintained for all fighters such that nations can only belong to one region and regions can only belong to one continent.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">locale_summary</span> <span class="o">&lt;-</span> <span class="n">fighter_vital_statistics</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Nation_continent</span><span class="p">,</span> <span class="n">Nation_region</span><span class="p">,</span> <span class="n">Nationality</span><span class="p">)</span>

<span class="n">locale_summary</span> <span class="o">&lt;-</span> <span class="n">locale_summary</span> <span class="o">%&gt;%</span>
  <span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">Nation_continent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">Nation_region</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">Nationality</span><span class="p">))</span>

<span class="c1"># assigning each nation to unique region and region to a continent
</span><span class="n">continent_summary</span> <span class="o">&lt;-</span> <span class="n">locale_summary</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Nation_continent</span><span class="p">,</span> <span class="n">Nation_region</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">group_by</span><span class="p">(</span><span class="n">Nation_region</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">summarize</span><span class="p">(</span><span class="n">Continent</span> <span class="o">=</span> <span class="n">Nation_continent</span><span class="p">[</span><span class="n">which.max</span><span class="p">(</span><span class="n">n</span><span class="p">)][</span><span class="m">1</span><span class="p">])</span>

<span class="n">region_summary</span> <span class="o">&lt;-</span> <span class="n">locale_summary</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Nation_region</span><span class="p">,</span> <span class="n">Nationality</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">group_by</span><span class="p">(</span><span class="n">Nationality</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">summarize</span><span class="p">(</span><span class="n">Region</span> <span class="o">=</span> <span class="n">Nation_region</span><span class="p">[</span><span class="n">which.max</span><span class="p">(</span><span class="n">n</span><span class="p">)][</span><span class="m">1</span><span class="p">])</span>

<span class="n">locale_summary</span> <span class="o">&lt;-</span> <span class="n">locale_summary</span> <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">region_summary</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Nationality"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Nation_continent</span><span class="p">,</span> <span class="n">Region</span><span class="p">,</span> <span class="n">Nationality</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">continent_summary</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Region"</span> <span class="o">=</span> <span class="s2">"Nation_region"</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Continent</span><span class="p">,</span> <span class="n">Region</span><span class="p">,</span> <span class="n">Nationality</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">ungroup</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">locale_summary</span> <span class="o">%&gt;%</span> <span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span> <span class="m">8</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Continent</th>
      <th style="text-align: left">Region</th>
      <th style="text-align: left">Nationality</th>
      <th style="text-align: right">n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">N. America</td>
      <td style="text-align: left">Northern America</td>
      <td style="text-align: left">United States</td>
      <td style="text-align: right">57170</td>
    </tr>
    <tr>
      <td style="text-align: left">S. America</td>
      <td style="text-align: left">South America</td>
      <td style="text-align: left">Brazil</td>
      <td style="text-align: right">18553</td>
    </tr>
    <tr>
      <td style="text-align: left">Europe</td>
      <td style="text-align: left">Northern Europe</td>
      <td style="text-align: left">United Kingdom</td>
      <td style="text-align: right">8190</td>
    </tr>
    <tr>
      <td style="text-align: left">Asia</td>
      <td style="text-align: left">Eastern Asia</td>
      <td style="text-align: left">Japan</td>
      <td style="text-align: right">5928</td>
    </tr>
    <tr>
      <td style="text-align: left">N. America</td>
      <td style="text-align: left">Northern America</td>
      <td style="text-align: left">Canada</td>
      <td style="text-align: right">4618</td>
    </tr>
    <tr>
      <td style="text-align: left">Europe</td>
      <td style="text-align: left">Eastern Europe</td>
      <td style="text-align: left">Russia</td>
      <td style="text-align: right">4478</td>
    </tr>
    <tr>
      <td style="text-align: left">N. America</td>
      <td style="text-align: left">Northern America</td>
      <td style="text-align: left">USA</td>
      <td style="text-align: right">2436</td>
    </tr>
    <tr>
      <td style="text-align: left">Europe</td>
      <td style="text-align: left">Eastern Europe</td>
      <td style="text-align: left">Poland</td>
      <td style="text-align: right">2361</td>
    </tr>
  </tbody>
</table>

<p>Having established a hierarchy of fighter locations, summarized based on the number of fighters residing in each country, nested within geographical regions and continents, we can visualize this hierarchy using a treemap. Essentially we will turn each country into a rectangle with area proportional to the number of fighter’s from that country. These rectangles will be nested according to the continent-region-nationality hierarchy.</p>

<p>To allow for clearer discrimination of regions (which will be especially useful for later analyses) we can shade similar countries with similar colors. Conventionally, we would only color one level of our hierarchy by either choosing unique colors for continents or regions or nations. If we only colored continents, we would only have a very coarse summary of geograophy. If we colored nations then similar country might receive very different shades of color.</p>

<p>Using a hierarchy to guide the choice of colors seems natural when such information is present. Here, I chose a general color for each continent, shades of that color for regions, and more specific colors for each country.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">treemap</span><span class="p">)</span>

<span class="n">source</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/manuscripts/blogs/Coloring_hierarchical_data/hierarchical_color_lib.R"</span><span class="p">)</span>

<span class="n">available_colors</span> <span class="o">&lt;-</span> <span class="n">extract_color_space</span><span class="p">(</span><span class="n">hmax</span> <span class="o">=</span> <span class="m">355</span><span class="p">,</span> <span class="n">lmin</span> <span class="o">=</span> <span class="m">30</span><span class="p">,</span> <span class="n">cmin</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span>

<span class="n">country_colors</span> <span class="o">&lt;-</span> <span class="n">identify_color_hierarchy</span><span class="p">(</span><span class="n">locale_summary</span><span class="p">,</span> <span class="n">available_colors</span><span class="p">,</span> <span class="n">weight_column</span> <span class="o">=</span> <span class="s2">"n"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">filter</span><span class="p">(</span><span class="n">Tier</span> <span class="o">==</span> <span class="s2">"Nationality"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="n">Nationality</span> <span class="o">=</span> <span class="n">Category</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span>

<span class="n">locale_summary</span> <span class="o">&lt;-</span> <span class="n">locale_summary</span> <span class="o">%&gt;%</span> <span class="n">ungroup</span> <span class="o">%&gt;%</span> <span class="n">left_join</span><span class="p">(</span><span class="n">country_colors</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Nationality"</span><span class="p">)</span>

<span class="n">treemap</span><span class="p">(</span><span class="n">locale_summary</span><span class="p">,</span> 
<span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Continent"</span><span class="p">,</span> <span class="s2">"Region"</span><span class="p">,</span> <span class="s2">"Nationality"</span><span class="p">),</span>
<span class="n">vSize</span> <span class="o">=</span> <span class="s2">"n"</span><span class="p">,</span>
<span class="n">vColor</span> <span class="o">=</span> <span class="s2">"Color"</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s2">"color"</span><span class="p">,</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">"Locations of MMA fighters"</span><span class="p">,</span>
<span class="n">fontsize.title</span> <span class="o">=</span> <span class="m">30</span><span class="p">,</span>
<span class="n">fontsize.labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">15</span><span class="p">))</span></code></pre></figure>

<p><img src="/figure/source/2016-05-13-summarizingFighters/unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" style="display: block; margin: auto;" /></p>

<p>By coloring and organizing fighter according to their nationality we can see that Mixed Martial Arts is truely a world-wide phenomenon, although its popularity is greatest in the USA, Europe, Brazil and Japan.</p>

<p>In my next post, I will demonstrate how the wide geographical distribution of MMA fighters and other factors such as weight class and gender structure the matchups between fighters. This structure emerges directly from the matchups between fighters and can be readily visualized by treating MMA fights as an undirected graph.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://www.fightprior.com/2016/05/05/summarizingFights/">
        Building a large database of MMA fight results II: quantitatively summarizing over 240,000 MMA fights
      </a>
    </h1>

    <span class="post-date">05 May 2016</span>

    <p>In my <a href="http://www.fightprior.com/2016/04/29/scrapingMMA/">last post</a>, I discussed how it was possible to extract match-level summaries of more than 240,000 unique MMA bouts between 143,602 fighters. In this entry, I will discuss how data from individual webpages can be combined into a single table with comparable entries. I will then show some high-leve</p>

<p>Data from fighters was obtained one webpage at a time, with the fields from one website saved as elements of a list. The fields that we want to work with for the first fighter in this list, Andrei Arlovski, are:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">load</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/raw_fight_data/fighter_output.Rdata"</span><span class="p">)</span>

<span class="n">fighter_output</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">query</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## [1] "/fighter/Andrei-Arlovski-270"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">kable</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">vital_stats</span><span class="p">,</span> <span class="n">row.names</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Name</th>
      <th style="text-align: left">Nickname</th>
      <th style="text-align: left">Birthday</th>
      <th style="text-align: right">Height</th>
      <th style="text-align: right">Weight</th>
      <th style="text-align: left">nationality</th>
      <th style="text-align: left">weight_class</th>
      <th style="text-align: left">camp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Andrei Arlovski</td>
      <td style="text-align: left">The Pit Bull</td>
      <td style="text-align: left">1979-02-04</td>
      <td style="text-align: right">193.04</td>
      <td style="text-align: right">109.32</td>
      <td style="text-align: left">Belarus</td>
      <td style="text-align: left">Heavyweight</td>
      <td style="text-align: left">Jackson-Wink MMA</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">$</span><span class="n">opponents</span><span class="p">),</span> <span class="n">row.names</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Result</th>
      <th style="text-align: left">Fighter</th>
      <th style="text-align: left">Event</th>
      <th style="text-align: left">Method</th>
      <th style="text-align: left">Finish</th>
      <th style="text-align: left">Referee</th>
      <th style="text-align: left">R</th>
      <th style="text-align: left">Time</th>
      <th style="text-align: left">Tier</th>
      <th style="text-align: left">opponent_link</th>
      <th style="text-align: left">event_link</th>
      <th style="text-align: left">Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">loss</td>
      <td style="text-align: left">Stipe Miocic</td>
      <td style="text-align: left">UFC 195 - Lawler vs. Condit</td>
      <td style="text-align: left">TKO</td>
      <td style="text-align: left">Punches</td>
      <td style="text-align: left">Herb Dean</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">0:54</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Stipe-Miocic-39537</td>
      <td style="text-align: left">/events/UFC-195-Lawler-vs-Condit-47465</td>
      <td style="text-align: left">2016-01-02</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Frank Mir</td>
      <td style="text-align: left">UFC 191 - Johnson vs. Dodson 2</td>
      <td style="text-align: left">Decision</td>
      <td style="text-align: left">Unanimous</td>
      <td style="text-align: left">John McCarthy</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Frank-Mir-2329</td>
      <td style="text-align: left">/events/UFC-191-Johnson-vs-Dodson-2-42229</td>
      <td style="text-align: left">2015-09-05</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Travis Browne</td>
      <td style="text-align: left">UFC 187 - Johnson vs. Cormier</td>
      <td style="text-align: left">TKO</td>
      <td style="text-align: left">Punches</td>
      <td style="text-align: left">Mark Smith</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">4:41</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Travis-Browne-16785</td>
      <td style="text-align: left">/events/UFC-187-Johnson-vs-Cormier-42199</td>
      <td style="text-align: left">2015-05-23</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Antonio Silva</td>
      <td style="text-align: left">UFC Fight Night 51 - Bigfoot vs. Arlovski 2</td>
      <td style="text-align: left">KO</td>
      <td style="text-align: left">Punches</td>
      <td style="text-align: left">Jerin Valel</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">2:59</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Antonio-Silva-12354</td>
      <td style="text-align: left">/events/UFC-Fight-Night-51-Bigfoot-vs-Arlovski-2-37743</td>
      <td style="text-align: left">2014-09-13</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Brendan Schaub</td>
      <td style="text-align: left">UFC 174 - Johnson vs. Bagautinov</td>
      <td style="text-align: left">Decision</td>
      <td style="text-align: left">Split</td>
      <td style="text-align: left">John McCarthy</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Brendan-Schaub-33926</td>
      <td style="text-align: left">/events/UFC-174-Johnson-vs-Bagautinov-35505</td>
      <td style="text-align: left">2014-06-14</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Andreas Kraniotakes</td>
      <td style="text-align: left">Fight Nights - Battle on Nyamiha</td>
      <td style="text-align: left">TKO</td>
      <td style="text-align: left">Punches</td>
      <td style="text-align: left">NA</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">3:14</td>
      <td style="text-align: left">Pro</td>
      <td style="text-align: left">/fighter/Andreas-Kraniotakes-30848</td>
      <td style="text-align: left">/events/Fight-Nights-Battle-on-Nyamiha-33655</td>
      <td style="text-align: left">2013-11-29</td>
    </tr>
  </tbody>
</table>

<p>We can see that most of the match data is in the “opponents” entries, but this table is missing data from Andrei himself. In order to make use of this table, we will need to add an entry for Andrei’s name. Also, while Andrei Arlovski is a fairly distinctive name, not all MMA fighters will have unique names. In fact, there are 15 distinct Chris Smiths in our dataset and 17 Rafael Silvas! Since we will want to uniquely match fighters to their bouts, each fighter needs a unique identifier. Because each fighter has a unique webpage, these urls can be used as unique indicators.</p>

<p>To summarize each individual fighter’s matches, we can add the fighter’s url and name to his/her matches. Because the fields in all individual fighters’ tables will match, we can stack each fighter’s fight data to generate a table of all fights.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">all_bouts</span> <span class="o">&lt;-</span> 
  <span class="c1"># generate a list of tables: each fighter-specific entry has the fighter link,
</span>  <span class="c1"># fighter name and all bouts
</span>  <span class="n">lapply</span><span class="p">(</span><span class="n">fighter_output</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
  <span class="n">data.frame</span><span class="p">(</span><span class="n">Query</span> <span class="o">=</span> <span class="n">x</span><span class="o">$</span><span class="n">query</span><span class="p">,</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">x</span><span class="o">$</span><span class="n">vital_stats</span><span class="o">$</span><span class="n">Name</span><span class="p">,</span> <span class="n">x</span><span class="o">$</span><span class="n">opponents</span><span class="p">)</span>
  <span class="p">})</span> <span class="o">%&gt;%</span>
  <span class="c1"># stack the tables in each list entry 
</span>  <span class="n">bind_rows</span> <span class="o">%&gt;%</span>
  <span class="c1"># convert to a tbl_df for nicer displays
</span>  <span class="n">tbl_df</span></code></pre></figure>

<p>Now that we have aggregated data from all bouts into a single table we can start an exploratory analysis, but before we start interpreting this large raw dataset some cleanup may be necessary. Going forward, we will likely care about who fought, who won, and how they won. These first two questions are pretty straight forward, but there are lots of ways in which a fighter can win and the summary is often subjective. The two fields that address how a fight was won are the method of victory (such as Decision or KO) and the finish (a more specific indicator of the finishing-move such as by Armbar, Punches or Hadouken). Both of these fields need some processing: there are 99 unique methods in this dataset when only 7 unique methods are usually recognized. The rest of the variations are either misspelled, alternative terms or an irrelevant entry. Similarly there are 1185 unique finishes present including many rare finishes like “vomiting” or “injured falling through ropes.” To make better use of methods and finishes we can combine rare fields to generate a more informative core set.</p>

<h3 id="cleaning-up-methods">Cleaning up methods</h3>

<p>There are 99 unique methods in this dataset: some fields are correct as written such as submission and TKO, others are alternative words such as “No Contest” and “NC”, while many variations are misspellings of correct terms.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">all_methods</span> <span class="o">&lt;-</span> <span class="n">all_bouts</span> <span class="o">%&gt;%</span>
  <span class="c1"># count unique instances of each method
</span>  <span class="n">count</span><span class="p">(</span><span class="n">Method</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># arrange methods by frequency
</span>  <span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="c1"># generate a slot to
</span>  <span class="n">mutate</span><span class="p">(</span><span class="n">Method_overwrite</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">all_methods</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Method</th>
      <th style="text-align: right">n</th>
      <th style="text-align: left">Method_overwrite</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Submission</td>
      <td style="text-align: right">197076</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">TKO</td>
      <td style="text-align: right">121143</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Decision</td>
      <td style="text-align: right">103403</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">KO</td>
      <td style="text-align: right">34558</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">NA</td>
      <td style="text-align: right">12076</td>
      <td style="text-align: left">NA</td>
    </tr>
    <tr>
      <td style="text-align: left">Draw</td>
      <td style="text-align: right">8916</td>
      <td style="text-align: left">NA</td>
    </tr>
  </tbody>
</table>

<p>To reduce the methods to a set of essential terms: we can first flag correct terms and alternative spellings, then determine whether any other terms are similar to these entries. We then combine alternative terms and discard terms that don’t match to anything (these are terms that make no sense like “Shane Garrett”).</p>

<p>To identify misspellings, we can use approximate string matching. Starting with each “correct” term and a list of unmatched terms, we determine how many insertions, deletions or substitutions of letters are needed to generate each unmatched term (note: insertions are not as strictly penalized because many methods contain a note such “No Contest - Overturned by NSAC”). If the score is below a threshold, the two strings approximately match and can be combined.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># accurate terms and alternative names
</span><span class="n">primary_fields</span> <span class="o">&lt;-</span> <span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">]</span>

<span class="c1"># transformation costs
</span><span class="n">match_costs</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">insertions</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">deletions</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">substitutions</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span>
<span class="k">for</span><span class="p">(</span><span class="n">a_field</span> <span class="k">in</span> <span class="n">rev</span><span class="p">(</span><span class="n">primary_fields</span><span class="p">[</span><span class="o">!</span><span class="n">is.na</span><span class="p">(</span><span class="n">primary_fields</span><span class="p">)])){</span>
  <span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">agrep</span><span class="p">(</span><span class="n">a_field</span><span class="p">,</span> <span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span><span class="p">,</span> <span class="n">ignore.case</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">costs</span> <span class="o">=</span> <span class="n">match_costs</span><span class="p">,</span> <span class="n">max.distance</span> <span class="o">=</span> <span class="m">0.2</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="n">a_field</span>
<span class="p">}</span>

<span class="c1"># Combine similar categories
</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">grep</span><span class="p">(</span><span class="s1">'No Decision'</span><span class="p">,</span> <span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"NC"</span>
<span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">grep</span><span class="p">(</span><span class="s1">'No Contest'</span><span class="p">,</span> <span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="s2">"NC"</span>
<span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span> <span class="o">==</span> <span class="s2">"Disqualification"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s2">"DQ"</span>
<span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span> <span class="o">==</span> <span class="s2">"No Contest"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s2">"NC"</span>
<span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span> <span class="o">==</span> <span class="s2">"Unknown"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">NA</span>
<span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">[</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method</span> <span class="o">==</span> <span class="s2">"Points"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="s2">"Decision"</span>

<span class="n">table</span><span class="p">(</span><span class="n">all_methods</span><span class="o">$</span><span class="n">Method_overwrite</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## 
##   Decision         DQ       Draw         KO         NC Submission        TKO 
##          8          3          2          6         27         15          2</code></pre></figure>

<p>Using fuzzy string matching and a couple of rules to combine categories we can reduce combine 63 of the 99 reported methods into 7 essential categories.</p>

<h3 id="cleaning-up-finishes">Cleaning up finishes</h3>

<p>The problem of reducing the 1185 distinct finishes to an essential subset is considerably more challenging than condensing methods was. This primarily stems from three issues:</p>

<ol>
  <li>There are a large number of categories.</li>
  <li>Most categories are accurately described, but may be too specific to be useful.</li>
  <li>Some categories are inconsistent (e.g. winning by a draw, no contest by punches).</li>
</ol>

<p>Because of the latter two issues and in spite of the first issue, categories were manually combined into a focused and consistent subset of finishes.</p>

<p>Aggregating categories is a bit of an art. It would be difficult to identify trends in categories that were too small (&lt;100 instances), while categories that were too large might end up lumping together fundamentally different finishes. Taking the many categories of chokes as an example, some chokes are common and remained their own category (e.g. Triangle, Arm-Triangle, RNC, and Guillotine Choke), while uncommon chokes were either combined into a more general “Choke” category (e.g Crucifex and Peruvian Necktie) or combined with similar chokes (e.g. Flying Triangle to Triangle, Bulldog to Guillotine).</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">all_finishes</span> <span class="o">&lt;-</span> <span class="n">all_bouts</span> <span class="o">%&gt;%</span>
  <span class="c1"># count all unique combinations of method and finish
</span>  <span class="n">count</span><span class="p">(</span><span class="n">Method</span><span class="p">,</span> <span class="n">Finish</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># convert methods to consensus methods
</span>  <span class="n">left_join</span><span class="p">(</span><span class="n">all_methods</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Method"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># recount
</span>  <span class="n">count</span><span class="p">(</span><span class="n">Method_overwrite</span><span class="p">,</span> <span class="n">Finish</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>

<span class="c1"># load previously annotated categories
</span><span class="n">past_categories</span> <span class="o">&lt;-</span> <span class="n">read.delim</span><span class="p">(</span><span class="s2">"~/Desktop/MMA/software/data/annotations/Finish_categories.txt"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">tbl_df</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">Method_overwrite</span><span class="p">,</span> <span class="n">Finish</span><span class="p">,</span> <span class="n">specific</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">unique</span>

<span class="n">all_finishes</span> <span class="o">&lt;-</span> <span class="n">all_finishes</span> <span class="o">%&gt;%</span>
  <span class="c1"># join previously annotated categories to current methods and finishes
</span>  <span class="n">left_join</span><span class="p">(</span><span class="n">past_categories</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Finish"</span><span class="p">,</span> <span class="s2">"Method_overwrite"</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">rename</span><span class="p">(</span><span class="n">Finish_overwrite</span> <span class="o">=</span> <span class="n">specific</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="n">arrange</span><span class="p">(</span><span class="n">Method_overwrite</span><span class="p">,</span> <span class="n">Finish</span><span class="p">)</span>

<span class="n">all_results</span> <span class="o">&lt;-</span> <span class="n">all_bouts</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">Result</span><span class="o">:</span><span class="n">Finish</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Result</span><span class="p">,</span> <span class="n">Method</span><span class="p">,</span> <span class="n">Finish</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">all_methods</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="s2">"Method"</span><span class="p">)</span>  <span class="o">%&gt;%</span>
  <span class="n">left_join</span><span class="p">(</span><span class="n">all_finishes</span> <span class="o">%&gt;%</span> <span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Method_overwrite"</span><span class="p">,</span> <span class="s2">"Finish"</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Result</span><span class="p">,</span> <span class="n">Method_overwrite</span><span class="p">,</span> <span class="n">Finish_overwrite</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span></code></pre></figure>

<h3 id="summary-of-methods-and-finishes">Summary of methods and finishes</h3>

<p>To visualize the frequency of methods and finishes, I will use treemaps generated using the <a href="https://cran.r-project.org/web/packages/treemap/index.html">treemap</a> R package. A treemap visualizes the frequency of categories based on the area of a rectangle that they occupy (a category at 25% will occupy 25% of the total area). One nice feature about treemaps is that they can easily display hierarchical information. This won’t be useful for methods, but finishes can be grouped into subcategories to improve visualization.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">treemap</span><span class="p">)</span>

<span class="n">methods</span> <span class="o">&lt;-</span> <span class="n">finish_types</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">Method</span> <span class="o">=</span> <span class="n">Method_cleanup</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Method</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>

<span class="n">treemap</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> 
<span class="n">index</span> <span class="o">=</span> <span class="s2">"Method"</span><span class="p">,</span>
<span class="n">vSize</span> <span class="o">=</span> <span class="s2">"n"</span><span class="p">,</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">"Frequency of methods in MMA"</span><span class="p">,</span>
<span class="n">fontsize.labels</span> <span class="o">=</span> <span class="m">25</span><span class="p">,</span> <span class="n">fontsize.title</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-05-summarizingFights/unnamed-chunk-8-1.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" style="display: block; margin: auto;" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">finishes</span> <span class="o">&lt;-</span> <span class="n">finish_types</span> <span class="o">%&gt;%</span>
  <span class="n">select</span><span class="p">(</span><span class="n">Category</span> <span class="o">=</span> <span class="n">General_finish</span><span class="p">,</span> <span class="n">Finish</span> <span class="o">=</span> <span class="n">Finish_cleanup</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">Finish</span><span class="p">,</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>

<span class="n">treemap</span><span class="p">(</span><span class="n">finishes</span><span class="p">,</span> 
<span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Category"</span><span class="p">,</span> <span class="s2">"Finish"</span><span class="p">),</span>
<span class="n">vSize</span> <span class="o">=</span> <span class="s2">"n"</span><span class="p">,</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">"Frequency of finishes in MMA"</span><span class="p">,</span>
<span class="n">fontsize.labels</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">25</span><span class="p">),</span> <span class="n">fontsize.title</span> <span class="o">=</span> <span class="m">30</span><span class="p">)</span></code></pre></figure>

<p><img src="/figure/source/2016-05-05-summarizingFights/unnamed-chunk-9-1.png" title="plot of chunk unnamed-chunk-9" alt="plot of chunk unnamed-chunk-9" style="display: block; margin: auto;" /></p>

<p>By visualizing finishes, we can see that the majority of finishes fall into a relatively small number of categories. The most common specific finishes were punches (a massive category that was split into TKO, KO and submission to provide some resolution), unanimous decision and three major submissions (Armbar, RNC and Guillotine). The most common classes of finishes were punches, followed by chokes and then decision. The fourth largest class was essentially miscellaneous finishes, a class that primarily pertains to fights where a specific finish was not recorded.</p>

<p>Now that we have cleaned up the results of our MMA matches, in my next post, I will discuss how we can clean up the data on individual fighters. This will help shed light on the demographics of MMA fighters, focusing on where MMA fighters live and the relative frequency of different weight classes.</p>

<p>Stay tuned, because in a couple weeks, I will revisit this finishes dataset. In this post, we grouped all wins into 50 well-defined categories. Individual fighters do not tend to use all types of finishes but tend to specialize in a subset of correlated finishes. Looking at the cooccurence of pairs of finishes, we can get a high level picture of the major MMA styles.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://www.fightprior.com/2016/04/29/scrapingMMA/">
        Building a large database of MMA fight results I: scraping with rvest
      </a>
    </h1>

    <span class="post-date">29 Apr 2016</span>

    <p>While MMA is an exciting sport that offers many interesting data analysis opportunities, there is no existing dataset that has aggregated the results of the more than 400,000 fights that have occured to date. The challenge is not that the information is not available, rather that the information is distributed across thousands of webpages. If we are looking for individual fighters or MMA events, we can easily find a large amount of information about fighters and their fight histories.</p>

<p>For example, if we wanted to learn more about Andrei Arlovski we could look at his <a href="https://en.wikipedia.org/wiki/Andrei_Arlovski">wikipedia page</a> or any number of MMA-specific websites such as <a href="http://www.mixedmartialarts.com/fighter/Andrei-Arlovski:1C1B0969FAC99E77">mixedmartialarts.com</a> or <a href="http://www.sherdog.com/fighter/Andrei-Arlovski-270">sherdog.com</a>.</p>

<p><img src="http://www.fightprior.com/figure/2016-04-29-scrapingMMA/sherdog.png" alt="Arlovski sherdog page" class="align-right" /></p>

<p>These websites, taking Sherdog as an example, provide a massive amount of factual data on fighters’ past performances. We can see Andrei’s age, weight, height as well as a list of his previous fights. Importantly, for each of these fights, we have the opponent’s name and a link to their corresponding webpage, so we could visit their webpage by following the link. We could follow the link to Arlovski’s most recent opponent, Stipe Miocic, as well as the links to Arlovski’s other opponents; determine their opponents in turn: and continue this iterative process until all fighters have been explored. Before we can implement this strategy, we need to be able to extract opponents’ links from individual webpages in addition to the fight information in which we are interested.</p>

<h3 id="extracting-information-from-fighter-pages-using-rvest">Extracting information from fighter pages using rvest</h3>

<p>To make use of the information in web pages, we need to first specify the attributes that we are interested in extracting and then computationally extract these features.</p>

<p>Identifying common features of html can be challenging, but this process can be greatly simplified using CSS selectors like <a href="http://selectorgadget.com/">SelectorGadget</a>. Selector gadget allows you to interactively select the parts of the html that you are interested in and the parts that you don’t want selected in order to generate a set of rules that guide the data extraction.</p>

<h3 id="extracting-name-and-nickname">Extracting name and nickname</h3>

<p><img src="http://www.fightprior.com/figure/2016-04-29-scrapingMMA/nickname_CSS.png" alt="Name and nickname CSS" class="align-right" /></p>

<p>As an example, if we want to extract Arlovski’s name and nickname, then we can just click on his name and nickname and any fields that are extracted will be highlighted in green. If some fields are inappropriately selected (as shown below i.e., Andrei’s next fight in Ahoy Rotterdam), then these entries are then unselected and will be shown in red. From this input, SelectorGadget generates a minimal CSS selector that can then be used to extract name and nickname from Arlovski’s page or any other fighter’s page that we want to explore. For name and nickname this is: “.nickname em , .fn”.</p>

<p>Now that we have a CSS selector for name and nickname we need a way of programmatically extracting this information from webpages. To carry out this analysis, I will use the <a href="https://cran.r-project.org/">freely available</a> programming language R. R is well-suited for streamlined data analysis due to its many user-created packages. One such package that will form the backbone of my analysis is <a href="https://github.com/hadley/rvest">rvest</a>. I will also use dplyr and the %&gt;% convention to simplify and improve the readability of my analysis.</p>

<p>The R code to extract name and nickname from Sherdog is:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Load packages
</span><span class="n">library</span><span class="p">(</span><span class="n">rvest</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>

<span class="c1"># read the webpage page of the fighter that we are interested in
</span><span class="n">fighter_page</span> <span class="o">&lt;-</span> <span class="n">read_html</span><span class="p">(</span><span class="s2">"http://www.sherdog.com/fighter/Andrei-Arlovski-270"</span><span class="p">)</span>

<span class="n">fighter_page</span> <span class="o">%&gt;%</span>
  <span class="c1"># use CSS selector to extract relevant entries from html
</span>  <span class="n">html_nodes</span><span class="p">(</span><span class="s2">".nickname em , .fn"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># turn the html output into simple text fields
</span>  <span class="n">html_text</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## [1] "Andrei Arlovski" "The Pit Bull"</code></pre></figure>

<h3 id="extracting-fight-history-and-opponent-links">Extracting fight history and opponent links</h3>

<p>Now that we have extracted some basic fields from html, we want to pull out some more substantial data by obtaining fight histories and links to all opponents. We can again use the CSS selector to identify the  fight history section of the html. For Andrei Arlovski, this entry is “section:nth-child(4) td”</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Using our same fight page from before
</span><span class="n">fighter_table</span> <span class="o">&lt;-</span> <span class="n">fighter_page</span> <span class="o">%&gt;%</span>
  <span class="c1"># extract fight history
</span>  <span class="n">html_nodes</span><span class="p">(</span><span class="s2">"section:nth-child(4) td"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="c1"># not a well-behaved table so it is extracted as strings
</span>  <span class="n">html_text</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="c1"># wrap text to reform table
</span>  <span class="n">matrix</span><span class="p">(</span><span class="n">ncol</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">byrow</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># Add column names from first entries of table
</span><span class="n">colnames</span><span class="p">(</span><span class="n">fighter_table</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">fighter_table</span><span class="p">[</span><span class="m">1</span><span class="p">,]</span>
<span class="n">fighter_table</span> <span class="o">&lt;-</span> <span class="n">fighter_table</span><span class="p">[</span><span class="m">-1</span><span class="p">,,</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">F</span><span class="p">]</span>

<span class="n">fighter_table</span> <span class="o">&lt;-</span> <span class="n">fighter_table</span> <span class="o">%&gt;%</span>
  <span class="n">as.data.frame</span><span class="p">(</span><span class="n">stringsAsFactors</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">tbl_df</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="c1"># reorder
</span>  <span class="n">select</span><span class="p">(</span><span class="n">Result</span><span class="p">,</span> <span class="n">Fighter</span><span class="p">,</span> <span class="sb">`Method/Referee`</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Time</span><span class="p">,</span> <span class="n">Event</span><span class="p">)</span>

<span class="n">kable</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">fighter_table</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span> <span class="n">row.names</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span></code></pre></figure>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Result</th>
      <th style="text-align: left">Fighter</th>
      <th style="text-align: left">Method/Referee</th>
      <th style="text-align: left">R</th>
      <th style="text-align: left">Time</th>
      <th style="text-align: left">Event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">loss</td>
      <td style="text-align: left">Alistair Overeem</td>
      <td style="text-align: left">TKO (Front Kick and Punches)Marc Goddard</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">1:12</td>
      <td style="text-align: left">UFC Fight Night 87 - Overeem vs. ArlovskiMay / 08 / 2016</td>
    </tr>
    <tr>
      <td style="text-align: left">loss</td>
      <td style="text-align: left">Stipe Miocic</td>
      <td style="text-align: left">TKO (Punches)Herb Dean</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">0:54</td>
      <td style="text-align: left">UFC 195 - Lawler vs. ConditJan / 02 / 2016</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Frank Mir</td>
      <td style="text-align: left">Decision (Unanimous)John McCarthy</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">UFC 191 - Johnson vs. Dodson 2Sep / 05 / 2015</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Travis Browne</td>
      <td style="text-align: left">TKO (Punches)Mark Smith</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">4:41</td>
      <td style="text-align: left">UFC 187 - Johnson vs. CormierMay / 23 / 2015</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Antonio Silva</td>
      <td style="text-align: left">KO (Punches)Jerin Valel</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">2:59</td>
      <td style="text-align: left">UFC Fight Night 51 - Bigfoot vs. Arlovski 2Sep / 13 / 2014</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Brendan Schaub</td>
      <td style="text-align: left">Decision (Split)John McCarthy</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">UFC 174 - Johnson vs. BagautinovJun / 14 / 2014</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Andreas Kraniotakes</td>
      <td style="text-align: left">TKO (Punches)N/A</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">3:14</td>
      <td style="text-align: left">Fight Nights - Battle on NyamihaNov / 29 / 2013</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Mike Kyle</td>
      <td style="text-align: left">Decision (Unanimous)Dan Miragliotta</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">WSOF 5 - Arlovski vs. KyleSep / 14 / 2013</td>
    </tr>
    <tr>
      <td style="text-align: left">loss</td>
      <td style="text-align: left">Anthony Johnson</td>
      <td style="text-align: left">Decision (Unanimous)Kevin Mulhall</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">WSOF 2 - Arlovski vs. JohnsonMar / 23 / 2013</td>
    </tr>
    <tr>
      <td style="text-align: left">win</td>
      <td style="text-align: left">Mike Hayes</td>
      <td style="text-align: left">Decision (Unanimous)Valentin Tarasov</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">5:00</td>
      <td style="text-align: left">Fight Nights - Battle of Moscow 9Dec / 16 / 2012</td>
    </tr>
  </tbody>
</table>

<p>We obtain links to opponents separately from the text fields but we can just as easily access these fields from the html using the CSS selector rule: “td:nth-child(2) a”</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">fighter_links</span> <span class="o">&lt;-</span> <span class="n">fighter_page</span> <span class="o">%&gt;%</span>
  <span class="n">html_nodes</span><span class="p">(</span><span class="s2">"td:nth-child(2) a"</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">html_attr</span><span class="p">(</span><span class="s2">"href"</span><span class="p">)</span>

<span class="n">fighter_links</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">## [1] "/fighter/Alistair-Overeem-461" "/fighter/Stipe-Miocic-39537"   "/fighter/Frank-Mir-2329"      
## [4] "/fighter/Travis-Browne-16785"  "/fighter/Antonio-Silva-12354"</code></pre></figure>

<h3 id="finding-new-fighters-and-large-scale-extraction">Finding new fighters and large-scale extraction</h3>

<p>Now that we can extract fight information and a list of opponents for any query fighters, this approach can be scaled to extract data from many fighters.</p>

<p>To do so, I started with a few initial fighters and as I evaluated these fighters, I kept track of all opponent links. Once the set of fighters I was processing was completed, I then compared already analyzed fighters to those in the list of potentially new fighters. This approach is easily implemented using a while loop. At this scale, querying html becomes computationally intensive (both for the user and server). Accordingly, only accessing a page every 1-5 seconds is generally advisable (or as otherwise indicated by the <a href="http://www.robotstxt.org/">robots.txt</a>).</p>

<p>From the above fight summaries, it is also clear that some of the raw data we obtained can be directly used (such as fight Results resulting in a win or loss) while other data (such as Method/Referee) needs to be unpacked so that we can make use of its information.</p>

<h3 id="expanding-our-search-approach">Expanding our search approach</h3>

<p>One possibly unsatisfying aspect of searching for fighters based on their shared bouts is that while this  approach will reach a set of fighters who are connected via fights, it may not explore all fighters. For example, female fighters may be totally disconnected from male fighters such that if we started with a male fighter we would get all (or most) male fighters while if we started with a female, we might only reach female fighters. From a network perspective (where fighters are nodes and fights are edges), the fight network may be composed of multiple disconnected subnetworks.</p>

<p>One obvious approach to dealing with the possibility of multiple disconnected sets of fighters would be to initialize our search using a fighter in each category. This may work for the major male and female subnetworks but if small pockets of fighters who have only fought one another exist, it would be difficult to identify these groups. If we care about such fighters, we can modify our fighter-to-fighter search strategy to search for fighters in additional ways. To more comprehensively comb through possible fighters, we can modify our search strategy to include both the events (e.g. UFC 195) which fighters competed in as well as the organizations (e.g. UFC) that these events occurred in. From organizations we can query additional events and from events we can query all fighters that were involved.</p>

<p><img src="http://www.fightprior.com/figure/2016-04-29-scrapingMMA/scraping_strategy.png" alt="Fighter scraping strategy" /></p>

<h3 id="what-did-we-get">What did we get?</h3>

<p>From scraping the Sherdog database, I obtained data from 143602 fighters encompassing 484061 fight entries. While I will leave deeper analysis of this dataset for future analyses, one aspect of this dataset that we can quickly observe is how many fights MMA fighters usually have.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="c1"># bouts is a cleaned-up summary of this dataset (I will discuss its generation later on)
</span><span class="n">fight_counts</span> <span class="o">&lt;-</span> <span class="n">bouts</span> <span class="o">%&gt;%</span>
  <span class="c1"># count the number of each fighter's bouts
</span>  <span class="n">count</span><span class="p">(</span><span class="n">Fighter_link</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">rename</span><span class="p">(</span><span class="n">nfights</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">count</span><span class="p">(</span><span class="n">nfights</span><span class="p">)</span>
  

<span class="c1"># ggplot2 plotting theme
</span><span class="n">hist_theme</span> <span class="o">&lt;-</span> <span class="n">theme</span><span class="p">(</span><span class="n">axis.title</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">25</span><span class="p">),</span>
                    <span class="n">panel.background</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="s2">"gray93"</span><span class="p">),</span>
                    <span class="n">panel.border</span> <span class="o">=</span> <span class="n">element_rect</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"black"</span><span class="p">),</span>
                    <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span>
                    <span class="n">panel.grid.major.x</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span>
                    <span class="n">panel.grid.major.y</span> <span class="o">=</span> <span class="n">element_line</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"gray70"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">),</span>
                    <span class="n">axis.text</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">18</span><span class="p">,</span> <span class="n">hjust</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">vjust</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span>
                    <span class="n">axis.ticks</span> <span class="o">=</span> <span class="n">element_line</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">),</span>
                    <span class="n">axis.ticks.length</span> <span class="o">=</span> <span class="n">unit</span><span class="p">(</span><span class="m">0.15</span><span class="p">,</span> <span class="s2">"cm"</span><span class="p">))</span>

<span class="n">no_sci_conv</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scientific</span><span class="o">=</span><span class="n">FALSE</span><span class="p">)}</span>

<span class="n">ggplot</span><span class="p">(</span><span class="n">fight_counts</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">nfights</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">geom_point</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">"firebrick"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Number of fighters"</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">"log10"</span><span class="p">,</span> <span class="n">breaks</span> <span class="o">=</span> <span class="m">10</span><span class="o">^</span><span class="n">c</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">5</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">no_sci_conv</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_x_continuous</span><span class="p">(</span><span class="s2">"Number of fights"</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="s2">"log10"</span><span class="p">,</span> <span class="n">breaks</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">30</span><span class="p">,</span> <span class="m">100</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">hist_theme</span></code></pre></figure>

<p><img src="/figure/source/2016-04-29-scrapingMMA/nfights-1.png" title="plot of chunk nfights" alt="plot of chunk nfights" style="display: block; margin: auto;" /></p>

<p>Looking at this log-log scatter plot of # of bouts in each fighter’s career, it is clear that the majority of fighters have very short careers. Only 53 fighters have fought in more than 10 MMA bouts.</p>

<p>Another simple summary of the fight data that we can look at is when most of the fights in the data occurred.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">ggplot</span><span class="p">(</span><span class="n">bouts</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">Date</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">geom_histogram</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="s2">"firebrick"</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="m">2017-1990</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_y_continuous</span><span class="p">(</span><span class="s2">"Number of bouts"</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_x_datetime</span><span class="p">(</span><span class="s2">"Fight Date"</span><span class="p">,</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">as.POSIXct</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s2">"1990"</span><span class="p">,</span> <span class="s2">"2017"</span><span class="p">),</span> <span class="n">format</span> <span class="o">=</span> <span class="s1">'%Y'</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">hist_theme</span></code></pre></figure>

<p><img src="/figure/source/2016-04-29-scrapingMMA/fight dates-1.png" title="plot of chunk fight dates" alt="plot of chunk fight dates" style="display: block; margin: auto;" /></p>

<p>By looking at when fights have occurred we can see the explosive growth of MMA, with the vast majority of fights occurring within the last 10 years.</p>

<p>In my next post, I will discuss some of the methods that I used to turn raw fighter-centric data into large tables. I will also talk about ways of standardizing the inputs so that fighters can be fairly compared.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://www.fightprior.com/2016/01/02/placeholder-post/">
        Placeholder Post
      </a>
    </h1>

    <span class="post-date">02 Jan 2016</span>

    <p>This is a placeholder post.</p>

  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78280722-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
